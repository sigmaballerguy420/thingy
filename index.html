<!doctype html>
<html>

<head>
    <title>Desmond - Firmware Demo</title>
    <script src="7zz.umd.js"></script>
    <style>
        body {
            background: black;
            display: flex;
        }

        /* Sidebar */
        #sidebar {
            width: 200px;
            background-color: #333;
            padding: 10px;
            color: white;
            height: 100vh;
            position: fixed;
            top: 0;
            left: 0;
            display: flex;
            flex-direction: column;
        }

        #sidebar a {
            color: white;
            padding: 10px;
            text-decoration: none;
            display: block;
            margin: 5px 0;
            border-radius: 5px;
        }

        #sidebar a:hover {
            background-color: #575757;
        }

        /* Main content */
        #content {
            margin-left: 220px;
            padding: 20px;
            flex-grow: 1;
        }

        /* File input */
        input[type="file"] {
            position: absolute;
            transform: translate(-50%, -50%);
            left: 50%;
            top: 95%;
            color: white;
        }

        /* Controls popup */
        #controlsPopup {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            width: 400px;
            z-index: 1000;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.3);
        }

        #controlsPopup .closeBtn {
            color: black;
            background-color: transparent;
            border: none;
            font-size: 20px;
            position: absolute;
            top: 10px;
            right: 10px;
            cursor: pointer;
        }

        #controlsPopup .closeBtn:hover {
            color: red;
        }
    </style>
</head>

<body>
    <div id="sidebar">
        <div id="controlsButton" onclick="toggleControlsPopup()">Controls</div>
        <a href="#" onclick="loadGame('pvz.7z')">PVZ</a>
        <a href="#" onclick="loadGame('game2.nds')">Game 2</a>
        <a href="#" onclick="loadGame('game3.nds')">Game 3</a>
        <a href="#" onclick="loadGame('game4.nds')">Game 4</a>
    </div>

    <div id="content">
        <desmond-player></desmond-player>
        <input type="file" accept=".nds,.zip,.7z,.rar"></input>
    </div>

    <!-- Controls Popup -->
    <div id="controlsPopup">
        <button class="closeBtn" onclick="closeControlsPopup()">X</button>
        <div class="popupContent">
            <h3>Controls:</h3>
            <ul>
                <li>Arrow Keys: Move</li>
                <li>Z: Action Button</li>
                <li>X: Cancel</li>
                <li>A/B: Select Items</li>
                <li>Start: Pause</li>
            </ul>
        </div>
    </div>

    <script src="desmond.min.js"></script>
    <script>
        document.querySelector("input").onchange = async function () {
            let file = this.files[0];

            if (!file) return;

            if (file.name.endsWith(".nds")) {
                // Load directly if it's an .nds file
                document.querySelector("desmond-player").loadURL(URL.createObjectURL(file));
            } else if (file.name.endsWith(".zip") || file.name.endsWith(".7z") || file.name.endsWith(".rar")) {
                // Handle compressed files using 7z-WASM
                let reader = new FileReader();
                reader.onload = async function (event) {
                    try {
                        let archive = await SevenZip.extract(event.target.result);
                        let ndsFileName = Object.keys(archive).find(name => name.endsWith(".nds"));

                        if (ndsFileName) {
                            let blob = new Blob([archive[ndsFileName]], { type: "application/octet-stream" });
                            document.querySelector("desmond-player").loadURL(URL.createObjectURL(blob));
                        } else {
                            alert("No .nds file found in the archive!");
                        }
                    } catch (err) {
                        console.error("Decompression error:", err);
                        alert("Error extracting archive file.");
                    }
                };
                reader.readAsArrayBuffer(file);
            } else {
                alert("Unsupported file type. Please upload a .nds, .zip, .7z, or .rar file.");
            }
        };

        window.onload = function () {
            setTimeout(function () {
                document.querySelector("desmond-player").loadURL("../firmware.nds");
                document.querySelector("desmond-player").shadowRoot.querySelector("#top").style = "position: fixed;transform: translate(-50%, -50%);width: 40%;left: 50%;top: 30%;height: 40%;";
                document.querySelector("desmond-player").shadowRoot.querySelector("#bottom").style = "position: fixed;transform: translate(-50%, -50%);width: 40%;left: 50%;top: 70%;height: 40%;";
            }, 1000);
        };

        function toggleControlsPopup() {
            const popup = document.getElementById('controlsPopup');
            popup.style.display = popup.style.display === 'block' ? 'none' : 'block';
        }

        function closeControlsPopup() {
            document.getElementById('controlsPopup').style.display = 'none';
        }
    </script>
</body>
</html>
